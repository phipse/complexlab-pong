-- vim:set ft=lua:

require("L4");

local ld = L4.default_loader;

local dssvr = ld:new_channel();
local fbdrv = ld:new_channel();
local keybo = ld:new_channel();
local keyio = ld:new_channel();
local foo = ld:new_channel();

ld:start( { caps = {  fbdrv = fbdrv:svr(),
		      icu = L4.Env.icu,
		      sigma0 = L4.cast( L4.Proto.Factory, L4.Env.sigma0
		      ):create( L4.Proto.Sigma0 ),
		      keyb = keyio:svr(),
		      },
	      log = { "IO", "Y" } },
	      "rom/io rom/x86-legacy.devs rom/x86-fb.io" );

ld:start( { caps = {  vbus = fbdrv,
		      fb = foo:svr(),
		      },
	    log = { "FB", "B" } },
	    "rom/fb-drv -m 0x117" );

ld:start( { caps = {  vbus = keyio,
		      key = keybo:svr(),
		   },
	    log = { "Keyserv", "g" } },
	    "rom/keyboard_svr" );

ld:start( { caps = {  fbuffer = foo,
		      ds_svr = dssvr:svr(),
		      keyb = keybo:create(0),

		      },
	    log = { "Wrapper", "R" } },
	    "rom/console_svr" );

-- dummy clnt
ld:start( { caps = {  ds_svr = dssvr:create( 0 ), 
		      keyb = keybo:create( 0 ),
		      },
	    log = { "Client", "G" } },
	    "rom/clnt" );

-- debug console
ld:start( {   caps = {	keyb = keybo:create( 0 ),
			goosfb = dssvr:create( 0 ),
		      }, 
	      log = { "Console", "W" } },
	      "rom/debug" );
